# shellcheck shell=dash

main()(
    local x_cmd_pkg_version="$1"
    local x_cmd_pkg_branch="$2"
    local x_bash_pkg_branch="$3"
    local x_bash_env_branch="$4"
    x cd "$(x wsroot)"

    (
        if [ -d .x_bash_pkg ]; then
            x cd .x_bash_pkg && git switch "${x_bash_pkg_branch}" && git pull
        else
            git clone git@github.com:x-bash/pkg.git .x_bash_pkg -b "$x_bash_pkg_branch"
        fi
    ) || return 1

    (
        if [ -d .x_bash_env ]; then
            x cd .x_bash_env && git switch "${x_bash_env_branch}" && git pull
        else
            git clone git@github.com:x-bash/env.git .x_bash_env -b "$x_bash_env_branch"
        fi
    ) || return 1

    ___X_CMD_XRC_RELOAD=1 xrc pkg
    ___X_CMD_XRC_RELOAD=1 xrc env

    x:info "bundle package"
    if [ -d .tmp ]; then
        x cd .tmp && git switch "${x_cmd_pkg_branch}" && git pull || return 1
    else
        git clone git@github.com:x-cmd-pkg/x-cmd-pkg.git .tmp -b "$x_cmd_pkg_branch" && \
        x cd .tmp || return 1
    fi
    xws test_default_url && \
    x mkdir -p ../doc/   && \
    cp -r doc/* ../doc/
)

main "${___X_CMD_PKG_VERSION:-v0.0.1}" "${___X_CMD_PKG_BRANCH:-feat/link}" "${___X_BASH_PKG_BRANCH:-link}" "${___X_BASH_ENV_BRANCH:-link_unlink}"